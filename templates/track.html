{% extends "base.html" %}

{% block title %}Tracking{% endblock %}

{% block body %}
<h3>Track Something:</h3>
<form method="POST" id="track-form">
    <label>
        Type: <select id="event-type">
                <option name="event-type" value="habit">Habit</option>
                <option name="event-type" value="influence">Influence</option>
                <option name="event-type" value="symptom">Symptom</option>
        </select>
    </label>
    <br>
    <div id="type-dependent">
        <label>
            <span id="change-type1">Habit</span>:
            <select name="habit-id" id="habit-id" required>
                {% for habit in habits %}
                    <option value={{habit.id}}>{{habit.label}}</option>
                {% endfor %}
            </select>
            <select name="influence-id" id="influence-id" hidden>
                {% for influence in influences %}
                    <option value={{influence.id}}>{{influence.label}}</option>
                {% endfor %}
            </select>
            <select name="symptom-id" id="symptom-id" hidden>
                {% for symptom in symptoms %}
                    <option value={{symptom.id}}>{{symptom.label}}</option>
                {% endfor %}
            </select>
        </label>
        <br>
        <label>
            <span id="change-num">Units</span>:
            <input type="number" name="num" id="num" required>
        </label>
        <br>
        <label>Date/Time (optional):
            <input type="datetime-local" name="datetime" id="datetime">
        </label>
        <br>
        <label>Location: 
            <input type="text" name="location" id="location">
        </label>
        <button class="location-button" id="location-button">Get My Location</button>
        <br>
        <input type="submit" id="submit-button">
    </div>
</form>
<br>
<a href="/new" id="new-prompt" hidden>
    Add some <span id="change-type2">habits</span> to track here!
</a>
<br>
<br>
<h4>Pull events from GCal:</h4>
Click the button below to automatically track any events on your calendar with
the title of your habits in the name. You will be prompted to log into GCal if
you haven't already.
<br>
<br>
<form>
Time frame to check (default is past week):
<br>
<input type="date" name="start-date" id="start-date" required> to
<input type="date" name="end-date" id="end-date" required>
<br>
<input type="submit" id="gcal-habits-button" value="Get Events">
</form>
<br>

<script>

let eventInput = $("#event-type");


// this will populate the dropdown menus based on user's tracked event types
// if user has nothing added for that type, link to add new page
function changeForm () {

    let type = eventInput.val();

    if (type == "habit") {

        if ($("#habit-id").text().trim() != "") {
            
            $("#habit-id").attr("hidden", false);
            $("#habit-id").attr("required", true);
            $("#change-type1").text("Habit");
            $("#change-num").text("Units");

            $("#influence-id").attr("hidden", true);
            $("#symptom-id").attr("hidden", true);

        } else {
            
            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("habits");
            $("#new-prompt").attr("hidden", false);
        }

    } else if (type == "influence") {

        if ($("#influence-id").text().trim() != "") {

            $("#influence-id").attr("hidden", false);
            $("#influence-id").attr("required", true);
            $("#change-type1").text("Influence");
            $("#change-num").text("Intensity");

            $("#habit-id").attr("hidden", true);
            $("#symptom-id").attr("hidden", true);

        } else {
            
            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("influences");
            $("#new-prompt").attr("hidden", false);
        }

    } else if (type == "symptom") {

        if ($("#symptom-id").text().trim() != "") {

            $("#symptom-id").attr("hidden", false);
            $("#symptom-id").attr("required", true);
            $("#change-type1").text("Symptom");
            $("#change-num").text("Intensity");

            $("#influence-id").attr("hidden", true);
            $("#habit-id").attr("hidden", true);

        } else {

            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("symptoms");
            $("#new-prompt").attr("hidden", false);
        }
    }
}


// update form when page loads & when user chooses new event type
$(window).on("load", changeForm);
eventInput.on("change", changeForm);

// get location when button is clicked
$("#location-button").on('click', getLocation);

// track event when user submits form
$("#submit-button").on('click', trackEvent);

// this will get the user's location from the browser
function getLocation(event) {
    event.preventDefault();

    navigator.geolocation.getCurrentPosition(function (position) {
            $("#location").val(`${position.coords.latitude},${position.coords.longitude}`);
    });

    alert("Location retrieved");
}


// this will track event based on user inputs
function trackEvent(event) {
    event.preventDefault();

    const inputs = { 
        eventType: eventInput.val(), 
        typeId: $("#type-id").val(),
        num: $("#num").val(),
        datetime: $("#datetime").val(), 
        location: $("#location").val()
    };

    $.post("/track", inputs, function (response) {
        if (response.includes("tracked successfully")) {
            alert(response);

            $("#track-form")[0].reset();
            createDropdowns();
        }
    });
}


// this will enable GCal and track events from selected time period
// (or trailing week by default)
function trackGcalHabits(event) {
    event.preventDefault();
    
    const inputs = { 
        startDate: $("#start-date").val(),
        endDate: $("#end-date").val()
    };

    $.post("/track-gcal-habits", inputs, function (response) {
        if (response == "") {
            alert("No new events to track.");
        } else {
            alert(`Events tracked:\n${response}`);
        }
    });
}


// track GCal events when user clicks button 
$("#gcal-habits-button").on('click', trackGcalHabits);

</script>
{% endblock %}





























