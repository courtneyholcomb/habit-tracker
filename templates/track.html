{% extends "base.html" %}

{% block title %}Tracking{% endblock %}

{% block body %}
<div class="container">
    <div class="row">
        <div class="col">
            <h4>Start Tracking Something New</h4>
            <form action="/new" method="POST" id="new-form">
                <label>
                    Type: <select id="event-type-new">
                            <option name="event-type-new" value="habit">Habit</option>
                            <option name="event-type-new" value="influence">Influence</option>
                            <option name="event-type-new" value="symptom">Symptom</option>
                    </select>
                </label>
                <br>
                <label>
                    Title: <input type="text" name="label" id="label" required>
                </label>
                <br>
                <div id="unit-or-scale">
                    <label>
                        Unit of measurement: <input type="text" name="unit" id="unit" required>
                    </label>
                </div>
                <input class="btn btn-primary" type="submit">
            </form>
            <br>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#tracking-modal">
              What am I currently tracking?
            </button>

            <!-- Modal -->
            <div class="modal fade" id="tracking-modal" tabindex="-1" role="dialog" aria-labelledby="tracking-modal-label" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tracking-modal-label">Currently Tracking</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h6>Habits:</h6>
                            <table id="habit-list"></table>
                        <br>
                        <h6>Influences:</h6>
                            <table id="influence-list"></table>
                        <br>
                        <h6>Symptoms:</h6>
                            <table id="symptom-list"></table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>

        </div>
        <div class="col">
            <h4>Track an Event</h4>
            <form method="POST" id="track-form">
                <label>
                    Type: <select id="event-type-track">
                            <option name="event-type-track" value="habit">Habit</option>
                            <option name="event-type-track" value="influence">Influence</option>
                            <option name="event-type-track" value="symptom">Symptom</option>
                    </select>
                </label>
                <br>
                <div id="type-dependent">
                    <label>
                        <span id="change-type1">Habit</span>:
                        <select name="habit-id" id="habit-id" required>
                            {% for habit in habits %}
                                <option value={{habit.id}}>{{habit.label}}</option>
                            {% endfor %}
                        </select>
                        <select name="influence-id" id="influence-id" hidden>
                            {% for influence in influences %}
                                <option value={{influence.id}}>{{influence.label}}</option>
                            {% endfor %}
                        </select>
                        <select name="symptom-id" id="symptom-id" hidden>
                            {% for symptom in symptoms %}
                                <option value={{symptom.id}}>{{symptom.label}}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <br>
                    <label>
                        <span id="change-num">Units</span>:
                        <input type="number" name="num" id="num" required>
                    </label>
                    <br>
                    <label>Date/Time (optional):
                        <input type="datetime-local" name="datetime" id="datetime">
                    </label>
                    <br>
                    <label>Location (optional): 
                        <input type="text" name="location" id="location">
                    </label>
                    <button class="location-button" id="location-button">Get My Location</button>
                    <br>
                    <input type="submit" id="submit-button" class="btn btn-primary">
                </div>
            </form>
            <br>
            <a href="/new" id="new-prompt" hidden>
                Add some <span id="change-type2">habits</span> to track here!
            </a>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#gcal-modal">
              Pull Events from GCal
            </button>

            <!-- Modal -->
            <div class="modal fade" id="gcal-modal" tabindex="-1" role="dialog" aria-labelledby="gcal-modal-label" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="gcal-modal-label">Pull Events from GCal</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Click the button below to automatically track any events on your calendar with
                        the title of your habits in the name. You will be prompted to log into GCal if
                        you haven't already.
                        <br>
                        <br>
                        <form>
                            Time frame to check (default is past week):
                            <br>
                            <input type="date" name="start-date" id="start-date" required> to
                            <input type="date" name="end-date" id="end-date" required>
                            <br>
                            <input type="submit" id="gcal-habits-button" value="Get Events">
                        </form>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
        </div>
    </div>
</div>


<!-- JS for track section -->
<script>

let eventInputTrack = $("#event-type-track");


// this will populate the dropdown menus based on user's tracked event types
// if user has nothing added for that type, link to add new page
function changeForm () {
    
    let type = eventInputTrack.val();

    if (type == "habit") {

        if ($("#habit-id").text().trim() != "") {
            
            $("#habit-id").attr("hidden", false);
            $("#habit-id").attr("required", true);
            $("#change-type1").text("Habit");
            $("#change-num").text("Units");

            $("#influence-id").attr("hidden", true);
            $("#symptom-id").attr("hidden", true);

        } else {
            
            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("habits");
            $("#new-prompt").attr("hidden", false);
        }

    } else if (type == "influence") {

        if ($("#influence-id").text().trim() != "") {

            $("#influence-id").attr("hidden", false);
            $("#influence-id").attr("required", true);
            $("#change-type1").text("Influence");
            $("#change-num").text("Intensity");

            $("#habit-id").attr("hidden", true);
            $("#symptom-id").attr("hidden", true);

        } else {
            
            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("influences");
            $("#new-prompt").attr("hidden", false);
        }

    } else if (type == "symptom") {

        if ($("#symptom-id").text().trim() != "") {

            $("#symptom-id").attr("hidden", false);
            $("#symptom-id").attr("required", true);
            $("#change-type1").text("Symptom");
            $("#change-num").text("Intensity");

            $("#influence-id").attr("hidden", true);
            $("#habit-id").attr("hidden", true);

        } else {

            $("#type-dependent").attr("hidden", true);
            $("#change-type2").text("symptoms");
            $("#new-prompt").attr("hidden", false);
        }
    }
}


// update form when page loads & when user chooses new event type
$(window).on("load", changeForm);
eventInputTrack.on("change", changeForm);

// get location when button is clicked
$("#location-button").on('click', getLocation);

// track event when user submits form
$("#track-form").on('submit', trackEvent);

// this will get the user's location from the browser
function getLocation(event) {
    event.preventDefault();

    navigator.geolocation.getCurrentPosition(function (position) {
            $("#location").val(`${position.coords.latitude},${position.coords.longitude}`);
    });

    alert("Location retrieved");
}


// this will track event based on user inputs
function trackEvent(event) {
    debugger; 
    event.preventDefault();

    const inputs = { 
        eventType: eventInputTrack.val(), 
        typeId: $("#type-id").val(),
        num: $("#num").val(),
        datetime: $("#datetime").val(), 
        location: $("#location").val()
    };

    $.post("/track", inputs, function (response) {
        if (response.includes("tracked successfully")) {
            alert(response);

            $("#track-form")[0].reset();
            changeForm();
        }
    });
}


// this will enable GCal and track events from selected time period
// (or trailing week by default)
function trackGcalHabits(event) {
    event.preventDefault();
    
    const inputs = { 
        startDate: $("#start-date").val(),
        endDate: $("#end-date").val()
    };
    
    $.post("/track-gcal-habits", inputs, function (response) {
        if (response == "") {
            alert("No new events to track.");
        } else {
            alert(`Events tracked:\n${response}`);
        }
    });
}


// track GCal events when user clicks button 
$("#gcal-habits-button").on('click', trackGcalHabits);

</script>


<!-- JS for add new section -->
<script>

let eventInputNew = $("#event-type-new");

// show lists of event types when page loads
function showEventTypes() {

    const habitTableTop = "<tr><th>Title</th><th>Unit</th></tr>";
    const inflSympTableTop = "<tr><th>Title</th><th>Scale</th></tr>";

    let habitList = "";
    let influenceList = "";
    let symptomList = "";

    $.get("/user-event-types", function (response) {
        data = $.parseJSON(response)

        for (let habit of data.habits) {
            habitList += `<tr><td>${ habit.label }</td>
                          <td>${ habit.unit }</td></tr>`;
        }

        for (let influence of data.influences) {
            influenceList += `<tr><td>${ influence.label }</td>
                              <td>${ influence.scale }</td></tr>`;
        }

        for (let symptom of data.symptoms) {
            symptomList += `<tr><td>${ symptom.label }</td>
                            <td>${ symptom.scale }</td></tr>`;
        }

        if (habitList != false) {
            $("#habit-list").html(`${habitTableTop} + ${habitList}`);
        } else {
            $("#habit-list").html("You are not currently tracking any habits.");
        } 

        if (influenceList != false) {
            $("#influence-list").html(`${inflSympTableTop} + ${influenceList}`);
        } else {
            $("#influence-list").html("You are not currently tracking any influences.");
        } 
        
        if (symptomList != false) {
            $("#symptom-list").html(`${inflSympTableTop} + ${symptomList}`);
        } else {
            $("#symptom-list").html("You are not currently tracking any symptoms.");
        }
    });
}

$(window).on("load", showEventTypes);


// change input form based on event type selected
eventInputNew.on("change", function() {

    if (eventInputNew.val() == "influence" || eventInputNew.val() == "symptom") {
        $("#unit-or-scale").html(`<label> Intensity scale: 0 to 
            <input type="number" name="unit" id="unit" required></label>`);
    } else if (eventInputNew.val() == "habit") {
        $("#unit-or-scale").html(`<label> Unit of measurement: 
            <input type="text" name="unit" id="unit" required></label>`);
    }
  
});


// when form is submitted, add type to db, reset form & refresh lists
function addEventType(event) {
    event.preventDefault();

    formData = {
        eventType: eventInputNew.val(),
        label: $("#label").val(),
        unit: $("#unit").val()
    };

    getEventData = $.post("/new", formData, function (response) {
        alert(response);
        if (response.includes("added successfully")) {

            $("#new-form")[0].reset();

            $("#unit-or-scale").html(`<label>Unit of measurement: 
            <input type="text" name="unit" id="unit" required></label>`);

            showEventTypes();
        }
    });
}

$("#new-form").on("submit", addEventType);

</script>
{% endblock %}





























