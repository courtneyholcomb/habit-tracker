{% extends "base.html" %}

{% block title %}Tracking{% endblock %}

{% block body %}
<h3>Track Something:</h3>
<form action="/track" method="POST" id="track-form">
    <label>
        Type: <select id="event-type">
                <option name="event-type" value="habit">Habit</option>
                <option name="event-type" value="influence">Influence</option>
                <option name="event-type" value="symptom">Symptom</option>
        </select>
    </label>
    <br>
    <div id="event-details"></div>
    <label>
        Date/Time (optional): <input type="datetime-local" name="datetime" id="datetime">
    </label>
    <br>
    <label>
        <button class="location-button" id="location-button">Get My Location</button>
        <input type="text" name="location" id="location">
    </label>
    <br>
    <input type="submit" id="submut-button">
</form>
<br>
<h4>Pull events from GCal:</h4>
Click the button below to automatically track any events on your calendar with
the title of your habits in the name.
<form>
Time frame to check (default is past week):
<br>
<input type="date" name="start-date" id="start-date" required> to
<input type="date" name="end-date" id="end-date" required>
<br>
<input type="submit" id="gcal-habits-button" value="Get Events"></button>
</form>
<br>



<script>

let eventInput = $("#event-type")

// function getEventTypes() {
//     let data = $.get("/user-event-types", function (response) {
//         return $.parseJSON(response);
//     });

//     return data;
// }

function createDropdowns () {
    
    $.get("/user-event-types", function (response) {

        let data = $.parseJSON(response);


        $("#event-details").html(function () {
            let type = eventInput.val();
            let capType = type.charAt(0).toUpperCase() + type.slice(1);
            let start = `<label>${capType}: <select name="type-id" id="type-id"
                         required>`;
            let options = "";
            let measurement = "";

            if (type == "habit") {
                for (let habit of data.habits) {
                    options += `<option value=${habit.id}>${habit.label}</option>`;
                };

                measurement += "Units";
            } else if (type == "influence") {
                for (let influence of data.influences) {
                    options += `<option value=${influence.id}>${influence.label}
                                </option>`;
                };

                measurement += "Intensity";
            } else if (type == "symptom") {

                for (let symptom of data.symptoms) {
                    options += `<option value=${symptom.id}>${symptom.label}
                                </option>`;
                };

                measurement += "Intensity";
            }

            let end = `</select></label><br><label>
                ${ measurement }: <input type="number" name="num" id="num" 
                required></label>`;

            return `${start} ${options} ${end}`;
        });
    });
}

$(window).on("load", createDropdowns);
eventInput.on("change", createDropdowns);

// function showEventTypes() {

//     const habitTableTop = "<tr><th>Title</th><th>Unit</th></tr>";
//     const inflSympTableTop = "<tr><th>Title</th><th>Scale</th></tr>";

//     let habitList = "";
//     let influenceList = "";
//     let symptomList = "";

//     $.get("/user-event-types", function (response) {
//         data = $.parseJSON(response);

//         for (let habit of data.habits) {
//             habitList += `<tr><td>${ habit.label }</td>
//                           <td>${ habit.unit }</td></tr>`;
//         }

//         for (let influence of data.influences) {
//             influenceList += `<tr><td>${ influence.label }</td>
//                               <td>${ influence.scale }</td></tr>`;
//         }

//         for (let symptom of data.symptoms) {
//             symptomList += `<tr><td>${ symptom.label }</td>
//                             <td>${ symptom.scale }</td></tr>`;
//         }

//         $("#habit-list").html(`${habitTableTop} + ${habitList}`);
//         $("#influence-list").html(`${inflSympTableTop} + ${influenceList}`);
//         $("#symptom-list").html(`${inflSympTableTop} + ${symptomList}`);

//     });
// }

// $(window).on("load", showEventTypes);



function getLocation(event) {
    event.preventDefault();
    navigator.geolocation.getCurrentPosition(function (position) {
            $("#location").val(`${position.coords.latitude},${position.coords.longitude}`);
        });
    alert("Location retrieved");
}
    
$("#location-button").on('click', getLocation);



function trackEvent(event) {
    event.preventDefault();

    const inputs = { 
        eventType: eventInput.val(), 
        typeId: $("#type-id").val(),
        num: $("#num").val(),
        datetime: $("#datetime").val(), 
        location: $("#location").val()
    };

    $.post("/track", inputs, function (response) {
        if (response.includes("tracked successfully")) {
            alert(response);
            $("#track-form")[0].reset();
            $("#event-details").html(`<label>Habit:
            <select name="type-id" id="type-id" required>
            {% for habit in habits %}
                <option value={{habit.id}}>{{ habit.label }}</option>
            {% endfor %}
            </select></label><br><label>
            Units: <input type="number" name="num" id="num" 
            required></label>`);
        }
    });

}
    
$('#track-form input[type="submit"]').on('click', trackEvent);



function trackGcalHabits(event) {
    event.preventDefault();
    
    const inputs = { 
        startDate: $("#start-date").val(),
        endDate: $("#start-date").val()
    };

    $.post("/track-gcal-habits", inputs, function (response) {
        if (response == "") {
            alert("No new events to track.");
        } else {
        alert(`Events tracked:\n${response}`);
    }

    });
}

$("#gcal-habits-button").on('click', trackGcalHabits);

</script>
{% endblock %}





























