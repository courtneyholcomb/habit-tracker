{% extends "base.html" %}

{% block title %}Tracking{% endblock %}

{% block body %}

<form id="chart-params" action="/line1-data", method="POST">
    <label>
        Start date: <input type="date" name="start-date" id="start-date">
    </label>
    <br>
    <label>
        End date: <input type="date" name="end-date" id="end-date">
    </label>
    <br>
    <input type="submit" id="update-chart">
</form>

<div class="line-chart">
    <canvas id="line1" width="400" height="300"></canvas>
    <div id="line1-legend" class="chart-legend"></div>
</div>
<button id="group">Group by type</button>
<button id="ungroup">Ungroup</button>
<div id="bubble-chart"></div>


<script type="text/javascript">

let line1_canvas = $("#line1").get(0).getContext("2d");

window.onload = function () {
    $.post("/line1-data", function (response) {
        let data = $.parseJSON(response);
        let labels = data.labels;
        let datasets = data.datasets;

        let line_chart = new Chart(line1_canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },

        });
    });
}

$("#update-chart").on('click', function (event) {
    event.preventDefault();

    let dates = {
        startDate: $("#start-date").val(),
        endDate: $("#end-date").val()
    };

    $.post("/line1-data", dates, function (response) {
        let data = $.parseJSON(response);
        let labels = data.labels;
        let datasets = data.datasets;

        let line_chart = new Chart(line1_canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },

        });
    });
    }
);

// //////////////////////////////////////////



// var bubbleChart = function () {
//     var width = 600,
//         height = 400;

//     function chart(selection){        
//     // you gonna get here
//     }

//     chart.width = function(value) {
//         if (!arguments.length) {
//             return width;
//         }

//         width = value;
//         return chart;
//     }

//     chart.height = function(value) {
//         if (!arguments.length) {
//             return height;
//         }
//             height = value;
//             return chart;
//     }

//     return chart;
// }

// d

// var chart = bubbleChart().width(300).height(200);
(function () {

    var width = 800,
        height = 800;

    var svg = d3.select("#bubble-chart")
        .append("svg")
        .attr("class", "chart")
        .attr("height", height)
        .attr("width", width)
        .append("g")
        .attr("transform", "translate(0,0)")

    
    d3.queue()
        .defer(d3.json, "/bubble-chart-data")
        .await(ready)

    
    function ready (error, datapoints) {
        
        let minData = d3.min(datapoints, (d) => d.units );
        let maxData = d3.max(datapoints, (d) => d.units );
        let sizeScale = d3.scaleLinear()
                  .domain([minData, maxData])
                  .range([32, 70]);

        var collideForce = d3.forceCollide(function(d) {
            return sizeScale(d.units) + 3;
        });

        var simulation = d3.forceSimulation()
            .force("x", d3.forceX(width / 2).strength(0.05))
            .force("y", d3.forceY(height / 2).strength(0.05))
            .force("collide", collideForce);
            // .force('cluster', d3.forceCluster());

        simulation.nodes(datapoints)
            .on("tick", moveCircles);

        var groups = svg.selectAll("g")
            .data(datapoints)
            .enter()
            .append("g")
            .attr("class", "circle-group")
            .attr("assoc", function (d) {
                return d.associations;
            });
            // .attr("group", function (d) {
            //     return d.group;
            // })

        var circles = groups.append("circle")
            .attr("r", (d) => sizeScale(d.units))
            .attr("fill", function (d) {
                return d.fill;
            });

        var labels = groups.append("text")
            .text((d) => d.label)
            .attr("text-anchor", "middle");

        function moveCircles () {
            groups
                .attr("transform", function (d) {
                    return `translate(${d.x},${d.y})`;
                });
            }

        var splitForceX = d3.forceX(function(d) {

            if (d.group === 0) {
                return width * 1/3;
            } else if (d.group === 1) {
                return width * 1/3;
            } else if (d.group === 2) {
                return width * 2/3;
            }
        });

        var splitForceY = d3.forceY(function(d) {

            if (d.group === 0) {
                return height * 1/3;
            } else if (d.group === 1) {
                return height * 2/3;
            } else if (d.group === 2) {
                return height * 2/3;
            }
        });

        var combineForceX = d3.forceX(width / 2).strength(0.08);
        var combineForceY = d3.forceY(height / 2).strength(0.08);

        function groupCircles () {
            simulation.nodes(datapoints)
                .force("x", splitForceX)
                .force("y", splitForceY)
                .alphaTarget(0.5)
                .restart();
        }

        d3.select("#group").on("click", function () {
            groups.datum(function(d) {
                if (d.type === "habit") {
                    d.group = 0;           
                } else if (d.type === "influence") {
                    d.group = 1;
                } else if (d.type === "symptom") {
                    d.group = 2;
                }

                return d;
            });

            groupCircles();
        });

        d3.select("#ungroup").on("click", function () {
            simulation.nodes(datapoints)
                .force("x", combineForceX)
                .force("y", combineForceY)
                .alphaTarget(0.5)
                .restart();
        });

        d3.selectAll("#bubble-chart .circle-group").on("click", function (d) {
            
            clickedCircle = d3.select(this);
            associations = clickedCircle.attr("assoc");

            console.log(associations);

            groups.datum(function(d) {
                if (associations.includes(d.label)) {
                    d.group = 0;           
                } else {
                    d.group = 2;
                }

                return d;
            });

            clickedCircle.datum(function (d) {
                d.group = 0;
                return d;
            });
            

            groupCircles();
        });

    }

})();



</script>












{% endblock %}